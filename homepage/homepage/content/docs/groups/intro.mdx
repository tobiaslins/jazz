export const metadata = {
  description: "Manage permissions of CoValues using Groups. Learn how to add members to a Group, check permissions, and more."
};

import { CodeGroup } from "@/components/forMdx";
import { Alert } from "@garden-co/design-system/src/components/atoms/Alert";

# Groups as permission scopes

Every CoValue has an owner, which can be a `Group` or an `Account`.

You can use a `Group` to grant access to a CoValue to **multiple users**. These users can
have different roles, such as "writer", "reader" or "admin".

CoValues owned by an Account can only be accessed by that Account. Additional collaborators cannot be added,
and the ownership cannot be transferred to another Account. This makes account ownership very rigid.

Creating a Group for every new CoValue is a best practice, even if the Group only has a single user in it
(this is the default behavior when creating a CoValue with no explicit owner).

<Alert variant="info" className="flex gap-2 items-center my-4">
  Account ownership is kept for backwards compatibility, but will be removed in a future release.
</Alert>

## Creating a Group

Here's how you can create a `Group`.

<CodeGroup>
```tsx twoslash
import { Group } from "jazz-tools";

const group = Group.create();
```
</CodeGroup>

The `Group` itself is a CoValue, and whoever owns it is the initial admin.

You typically add members using [public sharing](/docs/groups/sharing#public-sharing) or [invites](/docs/groups/sharing#invites).
But if you already know their ID, you can add them directly (see below).

## Adding group members by ID

You can add group members by ID by using `Account.load` and `Group.addMember`.

<CodeGroup>
```tsx twoslash
const bobsID = "co_z123";

// ---cut---
import { Group, co } from "jazz-tools";

const group = Group.create();

const bob = await co.account().load(bobsID);

if (bob) {
  group.addMember(bob, "writer");
}
```
</CodeGroup>

**Note:** 
- Both `Account.load(id)` and `co.account().load(id)` do the same thing â€” they load an account from its ID.

<CodeGroup>
```tsx twoslash
const bobsID = "co_z123";
import { Group } from "jazz-tools";
const group = Group.create();

// ---cut---
import { ID, Account, co } from "jazz-tools";

const bob = await Account.load(bobsID);
// Or: const bob = await co.account().load(bobsID);

if (bob) {
  group.addMember(bob, "writer");
}
```
</CodeGroup>

## Changing a member's role

To change a member's role, use the `addMember` method.

<CodeGroup>
```ts twoslash
import { Group } from "jazz-tools";
import { createJazzTestAccount } from 'jazz-tools/testing';
const bob = await createJazzTestAccount();
const group = Group.create();
// ---cut---
group.addMember(bob, "reader");
```
</CodeGroup>

Bob just went from a writer to a reader.

**Note:** only admins can change a member's role.

## Removing a member

To remove a member, use the `removeMember` method.

<CodeGroup>
```ts twoslash
import { Group } from "jazz-tools";
import { createJazzTestAccount } from 'jazz-tools/testing';
const bob = await createJazzTestAccount();
const group = Group.create();
// ---cut---
group.removeMember(bob);
```
</CodeGroup>

Rules:
- All roles can remove themselves.
- Only admins can remove other users.
- An admin cannot remove other admins.
- As an admin, you cannot remove yourself if you are the only admin in the Group, because there has to be at least one admin present.

## Getting the Group of an existing CoValue

You can get the group of an existing CoValue by using `coValue.$jazz.owner`.

<CodeGroup>
```ts twoslash
import { createJazzTestAccount } from 'jazz-tools/testing';
import { co, z } from "jazz-tools";
const existingCoValue = await createJazzTestAccount();

const MyCoMap = co.map({
  color: z.string(),
});

// ---cut---
const group = existingCoValue.$jazz.owner;
const newValue = MyCoMap.create(
  { color: "red"},
  { owner: group }
);
```
</CodeGroup>

## Checking the permissions

You can check the permissions of an account on a CoValue by using the `canRead`, `canWrite` and `canAdmin` methods.

<CodeGroup>
```ts twoslash
import { co, z } from "jazz-tools";

const MyCoMap = co.map({
  color: z.string(),
});
// ---cut---
const value = await MyCoMap.create({ color: "red"})
const me = await co.account().getMe();

if (me.canAdmin(value)) {
  console.log("I can share value with others"); 
} else if (me.canWrite(value)) {
  console.log("I can edit value");
} else if (me.canRead(value)) {
  console.log("I can view value");
} else {
  console.log("I cannot access value");
}
```
</CodeGroup>

To check the permissions of another account, you need to load it first:

<CodeGroup>
```ts twoslash
import { co, z } from "jazz-tools";
import { createJazzTestAccount } from 'jazz-tools/testing';

const MyCoMap = co.map({
  color: z.string(),
});
const account = await createJazzTestAccount();
const accountID = account.$jazz.id;
// ---cut---
const value = await MyCoMap.create({ color: "red"})
const bob = await co.account().load(accountID);

if (bob) {
  if (bob.canAdmin(value)) {
    console.log("Bob can share value with others");
  } else if (bob.canWrite(value)) {
    console.log("Bob can edit value");
  } else if (bob.canRead(value)) {
    console.log("Bob can view value");
  } else {
    console.log("Bob cannot access value");
  }
}
```
</CodeGroup>
